<!DOCTYPE html>
<html lang="en">
<head>
    <title>Shower Presentation Engine</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="node_modules/@shower/material/styles/styles.css">
    <style>

        .shower {
            --slide-ratio: calc(16 / 9);
        }

	.slide {
	    padding-top:30px;
	}

	.shower.full .slide pre mark:not(:only-child):not(.visited):not(.active).next {
	    visibility: visible;
	    background-color: transparent;
	}

	.shower.full .slide pre mark:not(:only-child).next {
	    background-color: ;
	}

	.code_box {
	    padding: 10px;
	    border:1px solid black;
	    border-radius: 10px;
	    box-shadow: 2px 2px 5px rgb(70,70,70);
	}

	.code_file {
	}
	.cli {
	}

	.annotation_container {
	    position:relative
	}

	.annotation {
	    font-family: "Roboto", sans-serif;
	    font-size: 24px/2;
	    position:absolute;
	}

	.annotation.right {
	    left: 20px;
	}

	.output {
	    color: rgb(150,150,200);
	}

	.slide pre code.compact {
	    font-size:0.6em;
	    line-height:1.1;
	}

    </style>
</head>
<body class="shower list">

    <header class="caption">
      <h1>Modernizing Your Build System</h1>
      <p>John Haiducek</p>
    </header>

    <section class="slide" id="titleslide">

      <h2>Modernizing Your Build System</h2>
      <h3>Or, how to not reinvent the wheel</h3>
      <h3>John Haiducek</h3>
      <h3>CEDAR 2021</h3>

    </section>

    <section class="slide">
      <h2>Overview</h2>
      <ul>
	<li>Build systems</li>
	<li>Dealing with changing MPI interfaces</li>
	<li>Error handling in Fortran</li>
	<li>Fortran polymorphism</li>
	<li>Testing and documentation</li>
      </ul>
    </section>

    <section class="slide">

      <figure class="place">
	<blockquote>
	  <p>Those who do not understand Autoconf are condemned to reinvent it, poorly.</p>
	</blockquote>
	<figcaption>Autoconf documentation</figcaption>
      </figure>

    </section>

    <section class="slide">

      <h2>Coping with software complexity</h2>

      <div class="columns two">
	<div>
	  <figure>
	    <img src="images/compiler.png" width="150px"/>
	    <figcaption>Compilers convert a single source file to binary</figcaption>
	  </figure>
	</div>
	<div>
	  <figure>
	    <img src="images/build_system.png" width="350px"/>
	    <figcaption>Build systems process multiple source files and external libraries</figcaption>
	  </figure>
	</div>
      </div>
    </section>

    <section class="slide">
      <h2>Compiler alone can only handle the simplest case</h2>

      <pre class="code_box cli">
	<code>$ gfortran -o hello hello.f90
$ ./hello
<span class="output">Hello, world!</span></code>
      </pre>

      <p>If your program is complex and split into a lot of files, you have to run a lot of commands like this one</p>

    </section>

    <section class="slide">
      <h2>Makefiles to the rescue</h2>

      <div class="columns two">
	<div>
	  Makefile:
	  <pre class="code_box code_file">
	    <code>FC=gfortran
%.o: %.f90
	$(FC) -c $&lt;
hello: hello.o
	$(FC) -o hello hello.o</code>
	  </pre>
	</div>

	<div>
	  Build and run:
	  <pre class="code_box cli">
	    <code>$ make
<span class="output">gfortran -c hello.f90</span>
<span class="output">gfortran -o hello hello.o</span>
$ ./hello
<span class="output">Hello, world!</span></code>
	  </pre>
	</div>
      </div>

    </section>

    <section class="slide" id="not_portable">
      <h2>Makefiles aren&rsquo;t portable</h2>

	  <pre class="code_box code_file">
	    <code><mark class="next">FC=gfortran</mark><span class="annotation_container"><span class="annotation right next">What if the system uses a different compiler?</span></span>
%.o: %.f90
	<mark class="next">$(FC) -c $&lt;</mark><span class="annotation_container"><span class="annotation right next">What if the compiler needs extra switches to work?</span></span>
hello: hello.o
	$(FC) -o hello hello.o</code>
	  </pre>

	  <p class="next">What if our program has external dependencies (that could be located anywhere on the system)?</p>

    </section>

    <section class="slide">
      <h2>The non-scalable solution</h2>

      <div class="columns two">
	<div>
	  Makefile:
	  <pre class="code_box code_file">
	    <code><mark>include Makefile.linux.gfortran</mark>
%.o: %.f90
	$(FC) -c $&lt;
hello: hello.o
	$(FC) -o hello hello.o</code>
	  </pre>
	</div>
	<div>
	  Makefile.linux.gfortran
	  <pre class="code_box code_file">
	    <code>FC=gfortran</code>
	  </pre>
	<ul>
	  <li>Results in a proliferation of Makefile.(os).(compiler) files</li>
	  <li>User must manually select the correct OS/compiler</li>
	</ul>
	</div>
      </div>

    </section>

    <section class="slide">
      <h2>What makes a good build system</h2>

      <ul>
	<li>Simple to use: 2-3 easy commands to build and install</li>
	<li>Adapts to different compilers and operating systems</li>
	<li>Automatically finds external dependencies (and allows the user to override their locations)</li>
      </ul>

      <figure class="place bottom" style="width:60%;">
	<blockquote>
	  <p>The primary goal ... is making the <em>user's</em> life easier; making the <em>maintainer's</em> life easier is only a secondary goal.</p>
	</blockquote>
	<figcaption>Autoconf documentation</figcaption>
      </figure>

    </section>

    <section class="slide">
      <h2>These problems have already been solved</h2>

      <table>
	<thead>
	  <tr>
	    <th></th>
	    <th>Compiler detection</th>
	    <th>Dependency finding</th>
	    <th>Platforms</th>
	  </tr>
	</thead>
	<tbody>
	  <tr><td>Make</td><td>n</td><td>n</td><td>Unix-like</td></tr>
	  <tr><td>Autotools</td><td>y</td><td>y</td><td>Unix-like</td></tr>
	  <tr><td>CMake</td><td>y</td><td>y</td><td>Multiple</td></tr>
	</tbody>
      </table>
    </section>

    <section class="slide">
      <h2>Building with CMake</h2>

      CMakeLists.txt:
      <pre class="code_box code_file">
	<code>cmake_minimum_required(VERSION 3.0.2)
project(hello Fortran)
add_executable(hello hello.f90)</code>
      </pre>
    </section>

    <section class="slide">
      <h2>Building with CMake</h2>

      Build and run
      <pre class="code_box cli">
	<code class="compact">$ cmake /path/to/source/code
<span class="output compact">-- The Fortran compiler identification is GNU 11.1.0
-- Checking whether Fortran compiler has -isysroot
-- Checking whether Fortran compiler has -isysroot - yes
-- Checking whether Fortran compiler supports OSX deployment target flag
-- Checking whether Fortran compiler supports OSX deployment target flag - yes
-- Detecting Fortran compiler ABI info
-- Detecting Fortran compiler ABI info - done
-- Check for working Fortran compiler: /usr/local/bin/gfortran - skipped
-- Checking whether /usr/local/bin/gfortran supports Fortran 90
-- Checking whether /usr/local/bin/gfortran supports Fortran 90 - yes
-- Configuring done
-- Generating done
-- Build files have been written to: /build/dir/path</span>
$ make
<span class="output compact">Scanning dependencies of target hello
[ 50%] Building Fortran object CMakeFiles/hello.dir/hello.f90.o
[100%] Linking Fortran executable hello
[100%] Built target hello</span></code>
      </pre>

    </section>

    <section class="slide">
      <h2>MPI interfaces</h2>

      The problem: MPI standard includes 3 different Fortran interfaces
      <ul>
	<li>Legacy: <code>include 'mpif.h'</code></li>
	<li>Fortran 90: <code>use mpi</code></li>
	<li>Fortran 2008: <code>use mpi_f08</code></li>
      </ul>

      <p>Availability of these varies dependong on the MPI implementation, compiler, etc.</p>

    </section>

    <section class="slide">
      <h2>MPI interfaces</h2>

      <ul>
	<li>Legacy: <code>include 'mpif.h'</code>
	  <ul>
	    <li>Deprecated&mdash;might not be available in the future</li>
	    <li>Produces lots of type mismatch warnings on modern compilers</li>
	    <li>But: This is the only option in some cases</li>
	  </ul>
	</li>
      </ul>

    </section>

    <section class="slide">
      <h2>MPI interfaces</h2>

      <ul>
	<li>Fortran 90: <code>use mpi</code>
	  <ul>
	    <li>Call signatures are the same as legacy interface, but doesn't trigger all the compiler warnings</li>
	  </ul>
	</li>
	<li>Fortran 2008: <code>use mpi_f08</code>
	  <ul>
	    <li>Modernized interface, some call signatures are different (mostly just different data types for some arguments) <nobr>e.g. <code>INTEGER COMM</code> &rarr; <code>TYPE(MPI_Comm) comm</code></nobr></li>
	  </ul>
	</li>
    </ul>

    </section>

    <section class="slide">
      <h2>MPI interfaces</h2>

      <div class="columns two">
	<div>
	  <ul>
	    <li>Solution: Adaptable module to handle MPI import
	      <ul>
		<li>Preprocessor directives (set using CMake) determine which MPI interface is used</li>
	      </ul>
	  </ul>

	</div>
	<div>
	  <pre class="code_box code_file">
	  <code class="compact" style="font-size:0.9em;">#include "mpi_types.h"

module system_mpi
#ifdef HAVE_MPI_F08_MODULE
  use mpi_f08
#elif HAVE_MPI_F90_MODULE
  use mpi
#else
  include 'mpif.h'
#endif
end module system_mpi</code>
	  </pre>
	</div>
      </div>

      <div class="place bottom" style="padding-bottom:4em">
	<a href="https://github.com/lightda/system_mpi">https://github.com/lightda/system_mpi</a>
      </div>

    </section>

    <section class="slide">
      <h2>MPI interfaces</h2>

      <pre class="code_box code_file">
	<code class="compact" style="font-size:0.6em;">use system_mpi

MPI_COMM_TYPE::comm
MPI_REQUEST_TYPE::request
MPI_STATUS_TYPE::status
integer::ierr

call MPI_Init(ierr)

comm=MPI_COMM_WORLD

call MPI_Ibcast( &
   1,1,MPI_INTEGER,0,comm,request,ierr)

call MPI_Wait(request,status,ierr)

call MPI_Finalize(ierr)</code>
      </pre>

      <div class="place bottom" style="padding-bottom:4em">
	<a href="https://github.com/lightda/system_mpi">https://github.com/lightda/system_mpi</a>
      </div>

    </section>

    <div class="progress"></div>

    <script src="node_modules/@shower/core/dist/shower.js"></script>
    <!-- Copyright © 2021 Yours Truly, Famous Inc. -->

</body>
</html>
